<html>
<head>

    <title>DataTable</title>

    %%PLUGIN_CSS%%
    %%PLUGIN_JAVASCRIPT%%

</head>

<body>
<div id="table_div"></div>
</body>
</html>

<style type="text/css">
    body { background-color: #ddd; margin: 0; padding: 0;}
    #table_div { height: 100%; width: 100%; display: table;}
</style>



<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>
<script type='text/javascript' src='https://www.google.com/jsapi'></script>
<script type='text/javascript'>
    var chart;
    //var charts;
    var data;

    google.load('visualization', '1', {packages:['orgchart']});
    google.setOnLoadCallback(initChart);

    function displayData(sensorData) {

        if (data.getNumberOfRows()){
            data.removeRows(0, 10);
        }
        data.addRows(sensorData);
        chart.draw(data, options);
    }

    function loadData() {

        var networkMap = [];
        var channel_id = window.parent.location.pathname.match(/\d+/g);
        $.getJSON('https://api.thingspeak.com/channels/' + channel_id + '/feed/last.json', function(data) {
            networkMap.push([{v: data.field2, f:'Master\nNode Id: ' + data.field1 + '\nAddress: ' + data.field2},'','Node Id: ' + data.field1 + '\nAddress: ' + data.field2]);
           var nodes = [];
           var nodeIDs = data.field3.split(',');
           var nodeAddresses = data.field4.split(',');

            for (var index = 0; index < nodeIDs.length; ++index){
                var parent = nodeAddresses[index].substring(0,nodeAddresses[index].length-1);
                if (parent.length==1){
                    parent = "0" + parent;
                }
                nodes.push({nodeId:nodeIDs[index],nodeAddress:nodeAddresses[index],parent:parent});
            }

            for (var index = 0; index < nodes.length; ++index) {
            var k =  nodes[index];
            networkMap.push([{v: k.nodeAddress, f: 'Node Id: ' + k.nodeId + '\nAddress: ' + k.nodeAddress},k.parent,'Node Id: ' + k.nodeId + '\nAddress: ' + k.nodeAddress]);
            }

           /* for (var index = 0; index < data.feeds.length; ++index){
                var k = data.feeds[index];
                sensorData.push([k.created_at !== null ? new Date(k.created_at) : null, k.field3 !==null ? Number(k.field3) : null, k.field1 !== null ? Number(k.field1) : null, k.field2 !==null ? k.field2 : null, k.field5!== null ? k.field5 : null ]);
            };*/
            displayData(networkMap);
        });
    }

    function initChart() {

        data = new google.visualization.DataTable();
        data.addColumn('string', 'Name');
        data.addColumn('string', 'Parent');
        data.addColumn('string', 'ToolTip');

        chart = new google.visualization.OrgChart(document.getElementById('table_div'));
        options = {
            size: 'small'
        };



        loadData();

        setInterval('loadData()', 15000);
    }
</script>
